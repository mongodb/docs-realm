.. _dotnet-unity:

================================
Quick Start for Unity - .NET SDK
================================

.. meta::
   :description: Get started using Atlas Device SDK for .NET with a Unity project.
   :keywords: Realm, .NET SDK, code example

.. facet::
  :name: genre
  :values: tutorial

.. facet::
   :name: programming_language
   :values: csharp

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

This quick start demonstrates how to install and integrate Atlas Device SDK
for .NET into your Unity project. 

Prerequisites
-------------

- Create a Unity project using `2020.3.12f1 (LTS) <https://unity3d.com/get-unity/download/archive>`_

.. note::

    The .NET SDK may be compatible
    with other versions of Unity, but ``2020.3.12f1 (LTS)`` is the version that
    the SDK team uses for testing and development. We recommend
    using this version to ensure your project works with the SDK and
    that the install steps match the steps below since Unity's UI often changes
    between versions. 

.. _unity-install-realm:

Install the SDK
---------------

You could install the SDK manually with a tarball. However, we recommend
installing the .NET SDK through npm since it provides `notifications of version
updates through Unity's package manager
<https://docs.unity3d.com/Packages/com.unity.package-manager-ui@2.0/manual/index.html#PackManUpdate>`_.

.. tabs::

   .. tab:: Install with NPM
      :tabid: npm

      .. procedure::

         .. step:: Add NPM as a Scoped Registry


            Before you can download and use the sDK within your Unity project, you
            must add :npm:`NPM <>` as a `scoped registry
            <https://docs.unity3d.com/Manual/upm-scoped.html>`_. Adding NPM as a scoped
            registry configures Unity to communicate with NPM, allowing you to install
            packages, such as the .NET SDK.

            Open the `Unity package manager
            <https://docs.unity3d.com/Manual/upm-ui.html>`_ by clicking the
            :guilabel:`Window` tab on the top of the Unity menu. Click :guilabel:`Package
            Manager` from the :guilabel:`Window dropdown`. Then, click the gear icon on
            the right-hand corner. Select the :guilabel:`Advanced Project
            Settings` option from the dropdown.

            .. figure:: /images/unity-open-advanced-project-settings.png
               :alt: Select "Advanced Project Settings"

            Fill out the scoped registry form with the details below and click the save
            button.

            .. code-block:: none

             name = NPM
             URL = https://registry.npmjs.org
             Scope(s) = io.realm.unity

            .. figure:: /images/unity-add-scoped-registry-form.png
               :alt: Download the latest release of the .NET SDK


         .. step:: Add the SDK to the Project Manifest


            Now that Unity can install the .NET SDK from NPM, you need
            to add the SDK as a dependency in your  project's `manifest file
            <https://docs.unity3d.com/Manual/upm-manifestPrj.html>`_. Open
            "Packages/manifest.json" file in `Visual Studio
            <https://docs.microsoft.com/en-us/visualstudio/>`_ or another text editor. At
            the bottom of the dependency's object, add the field, "io.realm.unity" and
            its value, the .NET SDK version number you want to use in quotes.

            .. code-block:: none

             "io.realm.unity": "<version-number>"

            Remember to replace the ``<version-number>`` above with the actual version
            number. You can find the latest release version at the 
            `realm-dotnet GitHub repo <https://github.com/realm/realm-dotnet>`__. 
            Your full manifest file should look something like the following:

            .. code-block:: none

             {
              "dependencies": {
                ...
                "io.realm.unity": "10.21.0"
              },
              "scopedRegistries": [
                {
                  "name": "NPM",
                  "url": "https://registry.npmjs.org/",
                  "scopes": [
                    "io.realm.unity"
                  ]
                }
              ]
             }

            When you save this file, Unity downloads the specified version of
            the .NET SDK package from the NPM registry.

         .. step:: Verify the SDK Dependency and Check for Updates

            To verify that the SDK package has been downloaded from NPM,
            open your Unity package manager by clicking the :guilabel:`Window` tab on the
            top of the Unity menu. Click :guilabel:`Package Manager` from the
            :guilabel:`Window` dropdown. You should see the SDK on the :guilabel:`"Packages: In
            Project"` tab.

            .. figure:: /images/unity-realm-is-installed.png
               :alt: Unity Realm Installed

            If you see a green check icon next to the version number of the
            SDK package, that means your package is up-to-date. However, if
            you see the up arrow icon, a new version of the package is available. Clicking
            it gives you the option to upgrade to the latest release.


   .. tab:: Manually Install a Tarball
      :tabid: tarball

      .. procedure::

         .. step:: Download the Latest .NET SDK Release


            Before you begin using within your Unity project, you must
            download the .NET SDK.

            Navigate to the :github:`realm-dotnet repository releases
            <realm/realm-dotnet/releases>` page, and scroll down to the release you want
            to use in your project. If you are unsure of which release to use, you can use
            the one labeled **"latest release"** on the left row.

            .. figure:: /images/unity-find-latest-dotnet-release.png
               :alt: Find the latest release of the .NET SDK

            Scroll down to the **"Assets"** dropdown of the release and click the link
            labeled **"io.realm.unity-<version-number>.tgz"** to download the SDK.

            .. figure:: /images/unity-download-tgz.png
               :alt: Download the latest release of the .NET SDK


         .. step:: Add the Tarball to Your Projects Package Manager


            Move your downloaded .NET SDK tarball inside of your
            project. You can do this by dragging and dropping the file into your project's
            folder. Copying the tarball to your project folder and committing it to version
            control ensures other developers working on the project can just clone the
            repository and build without manually downloading the SDK dependency.

            Next, you must load the tarball into your project using the `Unity package manager
            <https://docs.unity3d.com/Manual/upm-ui.html>`_.

            To open the package manager, click the :guilabel:`Window` tab on the top of
            the Unity menu. Click :guilabel:`Package Manager` from the :guilabel:`Window
            dropdown`. Once the package manager model opens, click the :guilabel:`+` icon
            in the top left corner of the model. Select the :guilabel:`Add package from
            tarball...` option.

            .. figure:: /images/add-package-from-tar-unity.png
               :alt: Add package from tarball Unity UI

            Select your **"io.realm.unity-bundled-<version-number>.tgz"** file to
            begin importing your project.

.. _unity-integration-guide-import-realm:

Import the SDK
--------------

.. include:: /includes/tip-library-name-reflects-former-realm-naming.rst

`Create a C# script
<https://docs.unity3d.com/Manual/CreatingAndUsingScripts.html>`_ or use a C#
script you have already created. Open that script in `Visual Studio
<https://docs.microsoft.com/en-us/visualstudio/>`_ or another text editor and add
the following line to import your SDK package: 

.. code-block:: csharp

   using Realms;

.. _unity-integration-guide-using-realm-in-project:

Using the SDK in Your Unity Project
-----------------------------------

When developing with .NET SDK, the API
methods are the same regardless of whether you use Unity or another platform.
However, since Unity has some `scripting restrictions
<https://docs.unity3d.com/Manual/ScriptingRestrictions.html>`_, you should keep
the following additional considerations in mind when developing your project:

Managed Code Stripping
~~~~~~~~~~~~~~~~~~~~~~

Unity performs `managed code stripping <https://docs.unity3d.com/Manual/ManagedCodeStripping.html>`_, 
discarding any unused code from a build to reduce binary size. This may lead to issues when 
deserializing :manual:`BSON </reference/bson-types/>` into C# classes. For platforms 
that use `IL2CPP <https://docs.unity3d.com/Manual/IL2CPP.html>`_, such as iOS, 
managed code stripping is enabled by default. When working with BSON, use 
the `[Preserve] attribute <https://docs.unity3d.com/ScriptReference/Scripting.PreserveAttribute.html>`_ 
to prevent managed code stripping on types properties that are only populated by 
the serializer. Since those properties use 
`reflection <https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/reflection>`_, 
Unity cannot statically infer that the property setter is used. This means that 
unless you apply the ``[Preserve] attribute``, Unity will strip those properties 
away. For examples of when you may perform BSON deserialization, check out the 
:ref:`Access MongoDB <sdks-access-mongodb>` and :ref:`Call a Function
<sdks-call-function>` documentation.

Using the SDK While the Application is Quitting
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The .NET SDK cannot be accessed within the 
`AppDomain.DomainUnload Event <https://docs.microsoft.com/en-us/dotnet/api/system.appdomain.domainunload?view=net-5.0>`_ or 
the `Application.quitting <https://docs.unity3d.com/ScriptReference/Application-quitting.html>`_ event. 
This means you cannot write data to a database while the player application is quitting. 
If you need to store some data just before the app exits, consider using the 
`Application.wantsToQuit <https://docs.unity3d.com/ScriptReference/Application-wantsToQuit.html>`_ 
event instead.

.. important:: Known Issue When Developing With Unity on Windows

   On Windows, if you are using Device Sync, your project may crash when running
   multiple instances of your project since multiple processes are attempting to
   access the same synced database. If you are using a non-synced database,
   you are able to run multiple instances of your project without crashes. 

Additional Examples
-------------------

Check out the examples below for community-authored projects that 
demonstrate using the .NET SDK with Unity! 

.. note:: 

   The MongoDB Documentation team does not directly maintain these examples. 

- `MongoDB Devhub: Unity with Realm Articles <https://developer.mongodb.com/learn/?content=Articles&text=unity>`_
- `MongoDB Youtube Channel: Getting Started with the SDK for Unity <https://www.youtube.com/watch?v=df2qo8G2ZfU>`_
- `MongoDB Youtube Channel: Build an Infinite Runner Game with Unity and the SDK <https://www.youtube.com/watch?v=8S0NuFwFazY>`_
- `dodoTV42 Youtube Channel: How to SAVE and LOAD data in Unity3D with the SDK <https://www.youtube.com/watch?v=8jo_S02HLkI>`_
