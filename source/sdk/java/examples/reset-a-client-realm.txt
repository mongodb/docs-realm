.. _java-client-resets:

===============================
Reset a Client Realm - Java SDK
===============================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. seealso:: Learn More About Client Resets

   To learn about the causes of and strategies for handling client
   resets, check out the Sync :ref:`Client Resets <client-resets>` page.

A **client reset error** is a scenario where a client realm cannot sync
data with the application backend. Clients in this state may continue to
run and save data locally but cannot send or receive sync changesets
until they perform a client reset strategy.

You can handle client resets in your application using one of the
available **client reset strategies**:

- :ref:`Discard Unsynced Changes <java-discard-unsynced-changes>`:
  Restores the realm to a syncable state by discarding changes made
  since the last sync.

- :ref:`Manually Recover Unsynced Changes <java-manually-recover-unsynced-changes>`:
  Downloads a new copy of the realm, and moves the unsyncable realm
  to a backup. Migrate unsynced data from the backup copy of the
  realm to the new syncable copy.


.. _java-discard-unsynced-changes:

Discard Unsynced Changes
------------------------

.. versionadded:: 10.10.0

The **discard unsynced changes** client reset strategy helps you perform
a client reset with minimal code and minimal disruption to your application
workflow. This strategy restores your local realm to a syncable state without
closing the realm or missing notifications.

This strategy comes with a downside: it permanently deletes all
local unsynced changes made since the last successful sync of the realm.
Do not use the "discard unsynced changes" strategy if your application
cannot lose data already written to the client realm file but not yet
synced to the backend.

The "discard unsynced changes" strategy can handle every kind of client
reset error *except* for client resets triggered by
:ref:`breaking or destructive schema changes <destructive-changes-synced-schema>`.
If your application experiences a breaking schema change, this strategy
falls back to a mode that mimics the "manually recover unsynced changes"
strategy.

To handle client resets with the "discard unsynced changes" strategy, 
pass an instance of :java-sdk:`DiscardUnsyncedChangesStrategy
<io/realm/mongodb/sync/DiscardUnsyncedChangesStrategy.html>` to the
:java-sdk:`defaultSyncClientResetStrategy()
<io/realm/mongodb/AppConfiguration.Builder.html#defaultSyncClientResetStrategy(io.realm.mongodb.sync.DiscardUnsyncedChangesStrategy)>`
builder method when you instantiate your ``App``. Your
``DiscardUnsyncedChangesStrategy`` instance must implement the following
methods:

- ``onBeforeReset()``: called before the SDK executes this strategy,
  when the SDK receives a client reset error from the backend.
- ``onAfterReset()``: called after the SDK successfully executes this
  strategy. Provides a frozen copy of the original realm, as well as
  a live instance of the realm in a syncable state.
- ``onError()``: mimics the "manually recover unsynced changes"
  strategy. The SDK only calls this method when your application
  experiences a breaking schema change. For more information on
  how to handle this scenario, see
  :ref:`Discard Unsynced Changes after Breaking Schema Changes
  <java-discard-unsynced-changes-after-destructive-schema-changes>`.

The following example implements this strategy:

.. tabs-realm-languages::

   .. tab::
       :tabid: kotlin

       .. literalinclude:: /examples/generated/java/sync/ClientResetTest.codeblock.client-reset-discard-unsynced-changes.kt
         :language: kotlin
         :copyable: false

   .. tab::
       :tabid: java

       .. literalinclude:: /examples/generated/java/sync/ClientResetTest.codeblock.client-reset-discard-unsynced-changes.java
         :language: java
         :copyable: false

.. _java-discard-unsynced-changes-after-destructive-schema-changes:

Discard Unsynced Changes after Breaking Schema Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/destructive-schema-change-app-update.rst

If your application experiences a breaking schema change, the "discard
unsynced changes" strategy cannot handle the resulting client reset
automatically. Instead, you must provide a manual client reset
implementation in the ``onError()`` method. The following
example demonstrates how you can manually handle this error case by
discarding all unsynced changes:

.. tabs-realm-languages::

   .. tab::
       :tabid: kotlin

       .. literalinclude:: /examples/generated/java/sync/ClientResetTest.codeblock.client-reset-discard-unsynced-changes-with-simple-manual-fallback.kt
         :language: kotlin
         :copyable: false

   .. tab::
       :tabid: java

       .. literalinclude:: /examples/generated/java/sync/ClientResetTest.codeblock.client-reset-discard-unsynced-changes-with-simple-manual-fallback.java
         :language: java
         :copyable: false

.. _java-manually-recover-unsynced-changes:

Manually Recover Unsynced Changes
---------------------------------

.. note:: Manual Recovery Replaces ``SyncSession.ClientResetHandler``

   This strategy works just like the deprecated
   ``SyncSession.ClientResetHandler`` method of performing client resets.
   Applications that use deprecated client reset handling can switch
   directly to the "manually recover unsynced changes" strategy with
   no logic changes.

Manual recovery requires significant amounts of code, schema concessions,
and custom conflict resolution logic. To learn more about the **manually
recover unsynced changes** client reset strategy, see the
:ref:`Advanced Guide to Manual Client Reset Data Recovery
<java-advanced-manual-client-reset-data-recovery>`.
