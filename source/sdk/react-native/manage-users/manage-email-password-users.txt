.. _react-native-manage-email-password-users:

==============================================
Manage Email/Password Users - React Native SDK
==============================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

If you have enabled the email/password authentication provider in your App Services App,
you can register a new account, confirm an email address, and reset a user's password
in React Native client code.

Prerequisites
-------------

Before you can manage email/password users from your React Native app,
you must enable email/password authentication in your App Services App backend.
To learn more about configuring email/password authentication,
refer to :ref:`email-password-authentication` in the App Services documentation.

Configure User Authentication in Client
---------------------------------------

Wrap any components that need to manage email/password users with
``AppProvider``. These child components can access the
:realm-react-sdk:`useEmailPasswordAuth hook <functions/useEmailPasswordAuth.html>`
to manage email/password authentication.

.. include:: /examples/generated/react-native/v12/RealmWrapper.snippet.configure-user-provider.tsx.rst

.. _react-native-email-login:

Log In
------

Users must have a registered email/password account before they can log in.
After a user logs in, all components wrapped in ``UserProvider`` have access
to an instance of that user object through the ``useUser`` hook.

To log a user in with email and password:

#. Destructure ``logIn`` from the ``useEmailPasswordAuth`` hook.
#. Pass the user's email and password to ``LogIn``.

.. include:: /examples/generated/react-native/v12/LoginWithEmail.snippet.email-password-login.tsx.rst

.. _react-native-register-new-user:

Register a New User Account
---------------------------

Before you can register a new email/password user, you need to get their email
address and password. The email address must not be associated with another
email/password user and the password must be between 6 and 128 characters.

After registration, you must confirm a new user's email address before they can
log in to your app.

To register a new user account:

#. Destructure ``register`` from the ``useEmailPasswordAuth`` hook.
#. Pass the user's email and password to ``register()``.
#. Confirm the user's email address.

.. include:: /examples/generated/react-native/v12/LoginWithEmail.snippet.email-password-register.tsx.rst

.. _react-native-confirm-user:
.. _react-native-complete-confirmation:

.. _react-native-confirm-new-user:

Confirm a New User's Email Address
----------------------------------

New users must confirm that they own their email address before they can log in
to your app unless the provider is configured to :ref:`automatically confirm new
users <auth-automatically-confirm-users>`. The confirmation process starts
when you register a user and ends when you confirm them from your client code.

Email confirmation requries a valid ``token`` and ``tokenId``. You get these
values from different places depending on the provider configuration:

- :ref:`Send a confirmation email <auth-send-a-confirmation-email>`. The
  ``token`` and ``tokenId`` values are included as query parameters in the
  :guilabel:`Email Confirmation URL`.

- :ref:`Run a confirmation function <auth-run-a-confirmation-function>`, the
  ``token`` and ``tokenId`` values are passed to the function as arguments.

To confirm a registered user:

#. Destructure ``confirm`` and ``result`` from the ``useEmailPasswordAuth`` hook.
#. Pass ``token`` and ``tokenId`` to ``confirm()`` as an object.

.. This code example isn't tested because it's paricularly difficult to test
   in an idempotent way. And the App Services App is set to automatically
   confirm users. The SDK team doesn't properly test it either.

.. code-block:: typescript
   :source: typescript

   const {confirm, result} = useEmailPasswordAuth();

   const performConfirmation = () => {
     confirm({token, tokenId});
   };

.. _react-native-email-password-retry-user-confirmation:

Retry User Confirmation Methods
-------------------------------

The SDK provides methods to resend user confirmation emails or retry custom 
confirmation methods.

.. _react-native-resend-confirmation-email:

Resend a Confirmation Email
~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the provider is configured to :ref:`send a confirmation email
<auth-send-a-confirmation-email>`, Atlas App Services automatically sends a
confirmation email when a user registers. The email contains a link to the
configured :guilabel:`Email Confirmation URL` with a token that is valid for 
30 minutes. If a user does not follow the link and confirm within that period, 
they must request a new confirmation email.

To send a new confirmation email to a user, pass their email address to
:js-sdk:`EmailPasswordAuth.resendConfirmationEmail()
<Realm.Auth.EmailPasswordAuth.html#resendConfirmationEmail>`.

.. literalinclude:: /examples/generated/node/authenticate.snippet.resend-confirmation-email.js
   :language: javascript

.. _react-native-email-password-resend-confirmation-function:

Retry a User Confirmation Function
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To re-run your :ref:`custom confirmation function
<auth-run-a-confirmation-function>`, call the ``retryCustomConfirmation()`` method
with the user's email address:

.. literalinclude:: /examples/generated/node/authenticate.snippet.retry-user-confirmation-function.js
   :language: javascript

.. _react-native-reset-password:

Reset a User's Password
-----------------------

Resetting a user's password is a multi-step process.

1. In your client app, you provide a UI for the user to reset their password. 
   Your App Services App can then send an email or run a custom function 
   to confirm the user's identity.
#. After confirming the user's identity, you can complete the password reset 
   request. 
#. After the password reset is complete, the user can log in using the new 
   password.

For more information about how to set your preferred password reset method,
refer to the :ref:`App Services Email/Password Authentication documentation 
<email-password-authentication-password-resets>`.

.. _react-native-send-password-reset-email:

Send a Password Reset Email
~~~~~~~~~~~~~~~~~~~~~~~~~~~

To send password reset emails to confirm the user's identity, 
you must configure your App to :ref:`send a password reset email 
<auth-send-a-password-reset-email>`.

To begin the password reset process, call
:js-sdk:`EmailPasswordAuth.sendResetPasswordEmail()
<Realm.Auth.EmailPasswordAuth.html#sendResetPasswordEmail>` with the user's 
email. The email contains a link to the configured :guilabel:`Password Reset URL`.
The user must visit this URL within 30 minutes to confirm the reset.

.. literalinclude:: /examples/generated/node/authenticate.snippet.send-pass-reset-email.js
   :language: javascript

After the user has visited the URL from the password reset email, call
:js-sdk:`EmailPasswordAuth.resetPassword()
<Realm.Auth.EmailPasswordAuth.html#resetPassword>` with the user's email,
the new password, and the ``token`` and ``tokenId`` provided in the unique URL.

.. literalinclude:: /examples/generated/node/authenticate.snippet.complete-pass-reset.js
   :language: javascript

If the user does not visit the URL from the password reset email within 30 
minutes, the ``token`` and ``tokenId`` expire. You must begin the password 
reset process again.


.. _react-native-call-password-reset-function:

Call a Password Reset Function
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When you configure your app to :ref:`run a password reset function 
<auth-run-a-password-reset-function>`, you define the function that
should run when you call :js-sdk:`EmailPasswordAuth.callResetPasswordFunction()
<Realm.Auth.EmailPasswordAuth.html#callResetPasswordFunction>`.

This function can take a username, a password, and any number 
of additional arguments. You can use these arguments to specify details 
like security question answers or other challenges that the user should 
pass to successfully complete a password reset.

You might prefer to use a custom password reset function when you want to
define your own password reset flows. For example, you might send a custom
password reset email from a specific domain. Or you might use a service other 
than email to confirm the user's identity.

On the App Services side, you define the custom password reset function that
runs when you call this method. That function can return one of three possible
statuses:

- ``fail``
- ``pending``
- ``success``

A ``fail`` status is treated as an error by the SDK. The SDK ``callResetPasswordFunction()``
does not take return values, so it does not return a ``pending`` or ``success``
status to the client. 

.. _react-native-complete-password-reset:

Server-Side Pending Case
````````````````````````

Your :ref:`App Services password reset function 
<auth-run-a-password-reset-function>` may return ``pending`` if you want 
the user to take some additional step to confirm their identity. However, that
return value is not passed to the SDK's ``callResetPasswordFunction()``, so 
your client app must implement its own logic to handle a ``pending`` status.

.. literalinclude:: /examples/generated/node/authenticate.snippet.call-password-reset-function.js
   :language: javascript

Your server-side function might send an email using a custom email provider. 
Or you may use SMS to confirm the user's identity via text message. 

You have access to a ``token`` and ``tokenId`` in the App Services password 
reset function context. If you pass this information from your App Services 
password reset function, you can pass these values back to your app using
platform-specific deep linking or universal links. Then, your client 
application can call :js-sdk:`EmailPasswordAuth.resetPassword()
<Realm.Auth.EmailPasswordAuth.html#resetPassword>` to complete the password 
reset flow.

.. literalinclude:: /examples/generated/node/authenticate.snippet.complete-pass-reset.js
   :language: javascript

Server-Side Success Case
````````````````````````

If your :ref:`App Services password reset function 
<auth-run-a-password-reset-function>` does additional validation within 
the function, or if you have validated the user's identity prior to 
attempting to reset the password, you may configure the App Services function
to return ``success``. However, that return value is not passed to the SDK's 
``callResetPasswordFunction()``, so your client app must implement its 
own logic to handle a ``success`` status.

Calling the function in this example performs the entire password reset process.

.. literalinclude:: /examples/generated/node/authenticate.snippet.complete-pass-reset.js
   :language: javascript

useEmailPasswordAuth Hook
-------------------------

.. list-table::
   :header-rows: 1
   :widths: 15 50 35

   * - Method
     - Description
     - Example

   * - ``logIn``
     - Logs a user in using an email and password. You could also call
       ``logIn(Realm.Credentials.emailPassword(email, password))``.
       Returns a ``Realm.User`` instance of the logged-in user.
     - const {logIn, result} = useEmailPasswordAuth();

       const [email, setEmail] = useState("");
       const [password, setPassword] = useState("");

       const performLogin = () => {
         logIn({email, password});
       };

       if(result.pending) {
         return (<LoadingSpinner/>)
       }

       if(result.error) {
         return (<ErrorComponent/>)
       }

       if(result.success) {
         return (<SuccessComponent/>)
       }
       //...

   * - ``logOut``
     - Logs out the current user.
     - .. code:: typescript

          const {logOut, result} = useEmailPasswordAuth();
          const performLogout = () => {
            logOut();
          }

   * - ``register``
     - Registers a new user. Requires a user email and password.
     - .. code:: typescript
     
          const {register, result} = useEmailPasswordAuth();

          const [email, setEmail] = useState("");
          const [password, setPassword] = useState("");

          const performRegister = () => {
            register({email, password});
          };

   * - ``confirm``
     - Confirms a user account. Requires a ``token`` and ``tokenId``.
     - :ref:`react-native-confirm-new-user` 

   * - ``resendConfirmationEmail``
     - Resends a confirmation email.
     - TODO:
        
   * - ``retryCustomConfirmation``
     - Retries confirmation with a custom function.
     - TODO:

   * - ``sendResetPasswordEmail``
     - Sends a password reset email.
     - TODO:

   * - ``resetPassword``
     - Completes resetting a user's password.
     - TODO:

   * - ``callResetPasswordFunction``
     - Calls your App Services backend password reset function. Can pass 
       arguments to the function as needed.
     - TODO:
