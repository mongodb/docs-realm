.. _react-native-open-a-synced-realm:
.. _react-native-realms:
.. _react-native-synced-realm:

===========================================
Configure a Synced Realm - React Native SDK
===========================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

You can configure a realm to automatically synchronize data between many devices
that each have their own local copy of the data. 

For more information about synced realms, including directions on how to set up
sync in an App Services App, refer to :ref:`Atlas Device Sync Overview <sync>`.

For more information about different realm configurations, refer to
:ref:`Configure a Realm <react-native-configure-realm>`.

Prerequisites
-------------

Before you configure a realm with Flexible Sync in a React Native application:

#. :ref:`Enable Flexible Sync on the backend <enable-flexible-sync>`.
   You must configure Flexible Sync in the backend before you can use it with your
   client application.
#. :ref:`Initialize the App client <react-native-connect-to-mongodb-realm-backend-app>`.
#. :ref:`Authenticate a user <react-native-authenticate-users>` in your client
   project.

@realm/react Providers and Hooks
--------------------------------

.. cssclass:: config-table
.. list-table::
   :header-rows: 1
   :widths: 15 50 35

   * - Provider/Hook
     - Description
     - Example

   * - :realm-react-sdk:`AppProvider <functions/AppProvider.html>`
     - React component that provides an App Services App instance for the
       Sync hooks. An ``AppProvider`` is required for a client to use Sync hooks.
     - See :ref:` <>`

   * - :realm-react-sdk:`useApp <functions/useApp.html>`
     - Accesses the current App Services App instance from the ``AppProvider``
       context.
     - .. code:: javascript
     
        const app = useApp();

   * - :realm-react-sdk:`useAuth <functions/useAuth.html>`
     - Provides methods and state for authenticating with an App Services App.
     - .. code:: javascript
     
        const auth = useAuth();

   * - :realm-react-sdk:`useEmailPasswordAuth <functions/useEmailPasswordAuth.html>`
     - Provides methods and state for authenticating with an App Services App
       using email and password authentication. It also contains utility methods,
       like resetting a password and confirming a user.
     - .. code:: javascript
     
        const auth = useEmailPasswordAuth();

   * - :realm-react-sdk:`UserProvider <functions/UserProvider.html>`
     - React component that provides a Realm user for the Sync hooks. A
       UserProvider is required for an app to use Sync hooks.
     - See :ref:` <>`

   * - :realm-react-sdk:`useUser <functions/useUser.html>`
     - Accesses the currently-authenticated Realm user from the ``UserProvider``
       context. The user is stored as React state and will trigger a re-render
       whenever it changes.
     - .. code:: javascript
     
        const user = useUser();

   * - :realm-react-sdk:`RealmProvider <functions/RealmProvider.html>`
     - A wrapper that exposes a realm to its child components, which have access
       to hooks that let you read, write, and update data.
     - See :ref:` <>`

   * - :realm-react-sdk:`useRealm <functions/useRealm.html>`
     - Returns the instance of the Realm opened by the RealmProvider.
     - .. code:: javascript
     
        const realm = useRealm();

   * - :realm-react-sdk:`useObject <functions/useObject.html>`
     - Returns an object (``Realm.Object<T>``) from a given type and value of
       primary key. Updates on any changes to the returned object. Returns
       ``null`` if the object either doesn't exists or has been deleted.
     - .. code:: javascript
     
        const myTask = useObject(Task, _id);
      
   * - :realm-react-sdk:`useQuery <functions/useQuery.html>`
     - Returns a collection of objects (``Realm.Results<T & Realm.Object T>``)
       from a given type. Updates on any changes to any object in the
       collection. Returns an empty array if the collection is empty.
     - .. code:: javascript
     
        const tasks = useQuery(Task);

.. _react-native-flexible-sync-open-realm:

Configure a Synced Realm
------------------------

You configre a a synced realm using the providers from ``@realm/react``.

By default, Realm syncs all data from the server before returning anything.
If you want to sync data in the background, read :ref:`Configure a Synced Realm
While Offline <react-native-open-synced-realm-offline>`.

To configure a synced realm:

#. Import providers from ``@realm/react``.
#. Configure ``AppProvider``.
#. Configure ``UserProvider`` and nest it within ``AppProvider``.
#. Configure ``RealmProvider`` for sync and nest it within ``UserProvider``.
   You must set up a sync subscription. The example below uses an initial subscription,
   but you can also set up subscriptions in ``RealmProvider`` child components.

This is how you nest providers:

.. literalinclude:: /examples/generated/react-native/ts/configure-realm-sync.test.snippet.configure-realm-sync-providers.tsx
   :language: javascript

.. note:: Partition-Based Sync

   This page covers Flexible Sync realms. Flexible Sync is the preferred mode for
   new apps that use :ref:`Atlas Device Sync <sync>`. For information about realms
   using the older Partition-Based Sync, refer to
   :ref:`Partition-Based Sync <react-native-partition-realms>`.

AppProvider
~~~~~~~~~~~

For more information about configuring and using ``AppProvider``, check
out the :ref:`Connect To Atlas App Services page
<react-native-app-client-configuration>`.

UserProvider
~~~~~~~~~~~~

You can also find information about ``UserProvider`` on the
:ref:`Authenticate Users page <react-native-authenticate-users>`.

RealmProvider
~~~~~~~~~~~~~

:realm-react-sdk:`RealmProvider <functions/RealmProvider.html>` is a wrapper
that exposes a realm to its child components. You configure your realm by
passing props to ``RealmProvider``.

When ``RealmProvider`` is rendered, it opens the realm. This means that the
provider renders successfully or its child components can't access the realm.

To configure a synced realm:

#. Import ``RealmProvider`` from ``@realm/react``.
#. Pass your object models to the ``schema`` prop.
#. Create a :js-sdk:`SyncConfiguration <Realm.App.Sync.html#~SyncConfiguration>`
   object.
#. Pass your ``SyncConfiguration`` object to the ``sync`` prop or add the object
   in-line.
#. Set up initial subscriptions or create a new subscription in
   ``RealmProvider`` child components.
#. Add other :js-sdk:`Configuration object <Realm.html#~Configuration>` 
   properties as props to ``RealmProvider`` to configure your realm.

.. literalinclude:: /examples/generated/react-native/ts/configure-realm-sync.test.snippet.configure-realm-sync-full.tsx
   :language: typescript
   :emphasize-lines: 8-19

Configuration Options
`````````````````````

You can configure ``RealmProvider`` by setting props that match the properties
of a :js-sdk:`SyncConfiguration object <Realm.App.Sync.html#~SyncConfiguration>`.
You can also set ``fallback`` and ``realmRef`` props.

- ``realmRef``
   Used with ``useRef`` to expose the configured realm to processes
   outside of ``RealmProvider``. This can be useful for things like a client
   reset fallback. 
- ``fallback``
   Rendered while waiting for the realm to open. Local realms
   usually open fast enough that the ``fallback`` prop isn't needed.

Open Synced Realm at Specific Path
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. versionadded:: ``realm@11.6.0``

Using :js-sdk:`AppConfiguration.baseFilePath <Realm.App.html#~AppConfiguration>`,
and :js-sdk:`Realm.Configuration.path <Realm.html#~Configuration>`, you can
control where Realm and metadata files are stored on client devices.

To do so, set ``AppProvider.baseFilePath``. If ``baseFilePath`` is not set, the
current work directory is used. You can also set ``RealmProvider.sync.path``
for more control.

.. tabs-realm-languages::

   .. tab::
      :tabid: typescript

      .. literalinclude:: /examples/generated/react-native/ts/configure-realm-path.test.snippet.configure-realm-path.tsx
         :language: typescript
         :emphasize-lines: 10, 13

   .. tab::
      :tabid: javascript

      .. literalinclude:: /examples/generated/react-native/js/configure-realm-path.test.snippet.configure-realm-path.jsx
         :language: typescript
         :emphasize-lines: 6, 9

If ``baseFilePath`` is set, metadata is always stored in
``<baseFilePath>/mongodb-realm/``. If ``baseFilePath`` isn't set, then metadata
is stored in ``<Realm.defaultPath>/mongodb-realm``.

Where, exactly, your Realm file is stored can vary depending
on how you set :js-sdk:`Realm.Configuration.path <Realm.html#~Configuration>`:

- ``Realm.Configuration.path`` is not set and ``baseFilePath`` is set. Your
  Realm file is stored at ``baseFilePath``.
- ``Realm.Configuation.path`` is set to a relative path. Your Realm file is
  stored relative to ``baseFilePath``.
- ``Realm.Configuration.path`` is an absolute path. Your Realm file is stored
  at ``Realm.Configuration.path``.

.. _react-native-open-synced-realm-offline:

Access a Synced Realm While Offline
-----------------------------------

The following subsections show how to use background synchronization to access a
realm while offline. To do this, use a cached user and an
:js-sdk:`OpenRealmBehaviorConfiguration
<Realm.App.Sync.html#~OpenRealmBehaviorConfiguration>` object. 

Within ``RealmProvider``'s sync configuration, set the optional ``newRealmFileBehavior`` 
and ``existingRealmFileBehavior`` fields to your ``OpenRealmBehaviorConfiguration`` 
object to enable background synchronization. 

You can open a realm immediately with background sync or after a timeout.

.. note:: Initial login requires a network connection

   When a user signs up for your app, or logs in for the first time with an 
   existing account on a client, the client must have a network connection.
   Checking for cached user credentials lets you open a realm offline, but
   only if the user has previously logged in while online.

.. _react-native-open-immediately-with-background-sync:

Access Immediately with Background Sync
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You may want to sync changes in the background to display partial data to the
user while the synced realm downloads data from the server, preventing the
user experience from being blocked. We recommend syncing changes in the
background for applications in which the user's device may go offline. To sync
changes in the background, open a synced realm synchronously.

.. tabs-realm-languages::

   .. tab::
      :tabid: typescript

      .. literalinclude:: /examples/generated/react-native/ts/configure-realm-sync-offline.test.snippet.offline-config.tsx
         :language: javascript

   .. tab::
      :tabid: javascript

      .. literalinclude:: /examples/generated/react-native/js/configure-realm-sync-offline.test.snippet.offline-config.jsx
         :language: javascript

.. _react-native-open-after-timeout-with-background-sync:

Access After Timeout with Background Sync
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you want to sync data but you're in an environment where it's uncertain if
the user has an Internet connection, specify a ``timeOut``. This
automatically opens the realm when either: 

- the timeout period elapses.
- the realm has completely downloaded.

If the realm doesn't finish downloading before the timeout, the initial
Sync continues in the background.

.. tabs-realm-languages::

   .. tab::
      :tabid: typescript

      .. literalinclude:: /examples/generated/react-native/ts/configure-realm-sync-timeout.test.snippet.timeout-config.tsx
         :language: javascript

   .. tab::
      :tabid: javascript

      .. literalinclude:: /examples/generated/react-native/js/configure-realm-sync-timeout.test.snippet.timeout-config.jsx
         :language: javascript
