.. _flutter-write-synced-realm:

==========================================
Write Data to a Synced Realm - Flutter SDK
==========================================

When writing data to a synced realm using Flexible Sync, you can use the same APIs
as writing to a local realm database. However, there are some differences
in behavior to keep in mind as you develop your application.
For more information on reading and writing data to a realm,
refer to :ref:`Read & Write Data <flutter-read-write-data>`

Examples on This Page
---------------------

The examples on this page use a app with the following Device Sync configuration
and Realm SDK data model and subscriptions.

Device Sync is configured with the following queryable fields:

- ``_id`` (always included)
- ``ownerId``

Device Sync has permissions configured to let users read and write only their own
data:

.. code-block:: json
   :emphasize-lines: 5-13

   {
     "rules": {},
     "defaultRoles": [
       {
         "name": "owner-read-write",
         "applyWhen": {},
         "read": {
           "ownerId": "%%user.id"
         },
         "write": {
           "ownerId": "%%user.id"
         }
       }
     ]
   }

The examples on this page use the following schema:

.. literalinclude:: /examples/generated/flutter/write_to_synced_realm_test.snippet.realm-model.dart
   :language: dart

Using that schema, the examples use the following realm and subscription query:

.. literalinclude:: /examples/generated/flutter/write_to_synced_realm_test.snippet.subscription-setup.dart
   :language: dart

Write to a Synced Realm
-----------------------

When you write to a synced realm, your write operations must match *both*
of the following criteria:

- **The sync subscription query.**
    - If your write operation doesn't match
      the query in the subscription, the write fails with a compensating write error.
    - To learn more about compensating write errors and how to avoid them,
      refer to the :ref:`Compensating Writes <flutter-compensating-writes>` section.
- **The Device Sync permissions** in your App Services App.
    - If your try to write data that doesn't match the Device Sync permissions expression,
      the write fails with a permission denied error.
    - To learn more about configuring Device Sync permissions for your app,
      refer to :ref:`sync-rules` and the :ref:`flexible-sync-permissions-guide`
      in the App Services documentation.

.. literalinclude:: /examples/generated/flutter/write_to_synced_realm_test.snippet.write-synced-realm.dart
   :language: dart

.. _flutter-compensating-writes:

Compensating Writes
-------------------

Compensating write errors occur when you write data to a realm locally
that doesn't align with the realm's sync subscriptions.

Because the local realm has no concept of "illegal" writes,
the write always initially succeeds locally.
Upon sync, the server will notice the illegal write. The server then undoes the change.
The undo operation, called a "compensating write", syncs back to the client
so the client's realm no longer has the illegal write.
Any local writes to a given object between an illegal write to that object
and the corresponding compensating write will be lost.

To learn more about compensating write errors and other Device Sync error types,
refer to :ref:`sync-errors` in the App Services documentation.

.. literalinclude:: /examples/generated/flutter/write_to_synced_realm_test.snippet.compensating-write.dart
   :language: dart
