.. _https-endpoints:

===============
HTTPS Endpoints
===============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. toctree::
   :titlesonly:
   :hidden:
   
   Configure HTTPS Endpoints </endpoints/configure>
   HTTPS Endpoint Requests and Responses </endpoints/requests-and-responses>

.. note::
   
   HTTPS endpoints replace webhooks from Realm's deprecated third-party
   service integrations. To learn how to migrate your existing webhooks,
   see :ref:`convert-webhooks-to-endpoints`.

Introduction
------------

Many modern applications use multiple external services to handle
complex use cases, such as messaging, analytics, and data management.
Those services often send data back by calling an HTTPS endpoint. You
can create HTTPS endpoints in {+service+} for these external services to
send data to your app.

{+app+} HTTPS endpoints are found at the following URL:

.. code-block::

   https://data.mongodb-api.com/app/<appId>/endpoint/<route>

Endpoint Configuration
----------------------

.. _endpoint-route:

Route
~~~~~

Every HTTPS endpoint has a unique route that serves as a name for the
endpoint. Clients call an endpoint by specifying its route in the
request URL.

Routes names must begin with a forward slash (``/``) and may contain
additional forward slashes to indicate a nested path.

.. _endpoint-http-method:

HTTP Method
~~~~~~~~~~~

You can configure an endpoint to accept only a specific :mdn:`HTTP
method <Web/HTTP/Methods>` or allow any method and handle each type
within the endpoint function.

HTTPS endpoints support the following standard HTTP methods:

- :mdn:`GET <Web/HTTP/Methods/GET>`
- :mdn:`POST <Web/HTTP/Methods/POST>`
- :mdn:`PUT <Web/HTTP/Methods/PUT>`
- :mdn:`PATCH <Web/HTTP/Methods/PATCH>`
- :mdn:`DELETE <Web/HTTP/Methods/DELETE>`

.. _endpoint-authentication:

Authentication
~~~~~~~~~~~~~~



.. _endpoint-authorization:

Authorization
~~~~~~~~~~~~~

.. _endpoint-function:

Endpoint Function
-----------------

Each HTTPS endpoint calls an associated :ref:`function <functions>` that
takes the incoming request as its first argument and the response sent
back to callers as the second argument:

.. code-block:: javascript

   exports = async function (request, response) {
     // 1. Parse the incoming request
     const bodyJson = JSON.parse(request.body.text());
     // 2. Run the endpoint logic
     await context.services
       .get("mongodb-atlas")
       .db("myDb")
       .collection("myCollection")
       .insertOne({ date: new Date(), requestBody: bodyJson });
     // 3. Configure the response
     response.setBody("Request was successful");
   }

.. _endpoint-request-object:

Request Objects
~~~~~~~~~~~~~~~

The first argument of an endpoint function is a ``request`` object that
includes information about the incoming HTTP request that called the
endpoint.

.. code-block:: json
   
   {
     "query": { "<Query Parameter>": "<Parameter Value>" },
     "headers": { "<Header>": ["<Header Value>"] },
     "body": <BSON.Binary>
   }

.. list-table::
   :header-rows: 1
   :widths: 30 70

   * - Field
     - Description
   
   * - ``query``
     - An object where each field maps a URL query parameter to its value.
   
   * - ``headers``
     - An object where each field maps a request header name to an array of one or more values.
   
   * - ``body``
     - A :ref:`BSON.Binary <bson-binary>` object that contains the
       request body. If the request did not include a body, this value
       is ``undefined``.

.. _endpoint-response-object:

Response Objects
~~~~~~~~~~~~~~~~

The second argument of an endpoint function is a ``response`` object
that represents HTTPS response sent back to the caller. The object
includes methods that you can call to configure the response.

.. list-table::
   :header-rows: 1
   :widths: 15 10 45

   * - Method
     - Description

   * - | ``setStatusCode(code)``
       | - ``code: number``
     - Set the HTTP response `status code
       <https://developer.mozilla.org/en-US/docs/Web/HTTP/Status>`_.

       .. example::

          .. code-block:: javascript

             response.setStatusCode(201);

   * - | ``setBody(body)``
       | - ``body: string | BSON.Binary``
     - Set the HTTP response `body
       <https://developer.mozilla.org/en-US/docs/Web/HTTP/Messages#Body_2>`_.

       If ``body`` is a string, it will be encoded to ``BSON.Binary``
       before being returned.

       .. example::

          .. code-block:: javascript

             response.setBody(
               "{'message': 'Hello, World!'}"
             );

   * - | ``setHeader(name, value)``
       | - ``name: string``
       | - ``value: string``
     - Set the HTTP response `header
       <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers>`_
       specified by ``name`` to the value passed in the ``value``
       argument. This overrides any other values that may have already
       been assigned to that  header.

       .. example::

          .. code-block:: javascript

             response.setHeader(
               "Content-Type",
               "application/json"
             );

   * - | ``addHeader(name, value)``
       | - ``name: string``
       | - ``value: string``
     - Set the HTTP response `header
       <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers>`_
       specified by ``name`` to the value passed in the ``value``
       argument. Unlike ``setHeader``, this does not override other
       values that have already been assigned to the header.

       .. example::

          .. code-block:: javascript

             response.addHeader(
               "Cache-Control",
               "max-age=600"
             );

             response.addHeader(
               "Cache-Control",
               "min-fresh=60"
             )
